#!/usr/bin/env ruby
require "rubygems"
require "bundler"
require "brpm_auto"
require "yaml"

def install_gem(module_name, module_version)
  if module_version
    BrpmAuto.log "Executing command 'gem install #{module_name} -v #{module_version}'..."
    specs = Gem.install(module_name, module_version)
  else
    BrpmAuto.log "Executing command 'gem install #{module_name}'..."
    specs = Gem.install(module_name)
  end
  BrpmAuto.log "Installed gems:"
  BrpmAuto.log specs.inspect
  specs
end

def install_bundle_if_necessary(spec)
  gemfile = File.join(spec.gem_dir, "Gemfile")
  gemfile_lock = File.join(spec.gem_dir, "Gemfile.lock")

  if File.exists?(gemfile) && File.exists?(gemfile_lock)
    BrpmAuto.log "Found a Gemfile.lock so executing command 'bundle install --gemfile #{gemfile}'..."
    # %x(bundle install --gemfile #{gemfile})
    result = BrpmAuto.execute_shell("bundle install --gemfile #{gemfile}")
    BrpmAuto.log result["stdout"] if result["stdout"] and ! result["stdout"].empty?
    unless result["status"] == 0
      raise result["stderr"]
    end
  end
end

def update_symlink_to_brpm_content(brpm_content_spec)
  if brpm_content_spec.version > Gem::Version.new(BrpmAuto.version)
    new_version_path = brpm_content_spec.gem_dir
    symlink_path = "#{ENV["GEM_HOME"]}/gems/brpm_content-latest"

    BrpmAuto.log "A newer version of brpm_content was installed so updating symlink #{symlink_path} to #{new_version_path}..."
    result = BrpmAuto.execute_shell("ln -sfn #{new_version_path} #{symlink_path}")
    BrpmAuto.log result["stdout"] if result["stdout"] and ! result["stdout"].empty?
    unless result["status"] == 0
      raise result["stderr"]
    end
  end
end

def install_auto_script_wrappers(spec, brpm_url, brpm_api_token)
  brpm_rest_client = BrpmRestClient.new(brpm_url, brpm_api_token)

  integration_servers = brpm_rest_client.get_integration_servers

  Dir.glob("#{spec.gem_dir}/{automations, resource_automations}/*.rb").each do |auto_script|
    #TODO: open txt file
    #TODO: add wrapper code
    #TODO: set integration server id if necessary

    script = {}
    brpm_rest_client.create_or_update_script(script)
  end
end



if ARGV.size < 1
  BrpmAuto.log "Missing arguments."
  BrpmAuto.log "Usage: brpm_install <module name> [<module version>]"
end

module_name = ARGV[0]
module_version = ARGV[1]

params = {}
params["log_file"] = "/tmp/brpm_install.log"
params["also_log_to_console"] = "true"
BrpmAuto.setup(params)

BrpmAuto.log "Installing module #{module_name} #{module_version.nil? ? "" : module_version}..."

specs = install_gem(module_name, module_version)
module_spec = specs.last

install_bundle_if_necessary(module_spec)

if ENV["BRPM_HOME"] and ! ENV["BRPM_HOME"].empty?
  brpm_content_spec = specs.find { |spec| spec.name == "brpm_content" }
  update_symlink_to_brpm_content(brpm_content_spec) if brpm_content_spec

  if File.exists?("~/.brpm")
    config = YAML.load_file("~/.brpm")

    if config["brpm_url"] and config["brpm_api_token"]
      install_auto_script_wrappers(spec, brpm_url, brpm_api_token)
    else
      BrpmAuto.log "Properties brpm_url and/or brpm_api_token don't exist in file ~/.brpm so not installing the automation script wrappers in BRPM. If you want to install them the next time you should add brpm_url and brpm_api_token properties in yaml format in file ~/.brpm."
    end
  else
    BrpmAuto.log "File ~/.brpm doesn't exist so not installing the automation script wrappers in BRPM. If you want to install them the next time you should create this file and add brpm_url and brpm_api_token properties in yaml format."
  end

  if module_name == "brpm_content"
    #TODO: cp $CONTENT_REPO_PATH/modules/framework/log.html $BRPM_HOME/automation_results

  end
end